<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Enlace al Manifiesto PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a202c">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/854/854878.png">
    <title>Calculadora de Kilometraje TI</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Excel Export (SheetJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    
    <!-- PDF Generation (jsPDF + AutoTable) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1a202c; color: #e2e8f0; }
        .container { max-width: 95%; margin: auto; padding: 1rem; }
        @media(min-width: 768px) { .container { max-width: 90%; padding: 2rem; } }
        
        .card { background-color: #2d3748; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        
        /* Estilos inputs */
        input, select {
            width: 100%; padding: 0.75rem; border-radius: 0.5rem;
            border: 2px solid #4a5568; background-color: #2d3748;
            color: #e2e8f0; outline: none; transition: border-color 0.2s;
        }
        input:focus, select:focus { border-color: #4299e1; }
        
        /* Botones Base */
        .btn {
            padding: 0.75rem 1.5rem; border-radius: 0.5rem; text-align: center;
            font-weight: 700; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

<!-- Botón de Instalación PWA (Oculto por defecto) -->
<div id="installContainer" class="hidden fixed top-4 right-4 z-50">
    <button id="btnInstall" class="btn bg-indigo-500 hover:bg-indigo-400 text-white shadow-lg animate-pulse">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
        Instalar App
    </button>
</div>

<div class="container mx-auto">
    <div class="card bg-gray-800 rounded-2xl shadow-xl">
        <h1 class="text-2xl md:text-3xl font-extrabold text-center mb-2 text-indigo-400">Soporte TI: Gastos de Viaje</h1>
        <p class="text-center text-xs text-gray-400 mb-6">Versión Offline Habilitada</p>

        <!-- Formulario Principal -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
                <label class="block text-gray-400 text-sm mb-1">Ciudad Salida</label>
                <select id="citySelectSalida"></select>
            </div>
            <div>
                <label class="block text-gray-400 text-sm mb-1">Ciudad Llegada</label>
                <select id="citySelectLlegada"></select>
            </div>
        </div>

        <div class="mb-6">
            <label class="block text-gray-400 text-sm mb-1">Destino Personalizado (o Ticket ID)</label>
            <input type="text" id="customLocationInput" placeholder="Ej. Cliente XYZ - Ticket #5044">
        </div>

        <div class="mb-6">
            <label class="block text-gray-400 text-sm mb-1">Fecha del Servicio</label>
            <input type="date" id="tripDate">
        </div>

        <div class="mb-6">
            <label class="block text-gray-400 text-sm mb-1">Kilometraje Maps (Ida)</label>
            <input type="number" id="kmInput" placeholder="0">
        </div>

        <!-- Botones de Acción -->
        <div class="flex flex-col md:flex-row gap-3 mb-4">
            <button onclick="calculateCost()" class="btn w-full bg-indigo-600 hover:bg-indigo-700">Calcular</button>
            <button onclick="resetCalculator()" class="btn w-full bg-gray-600 hover:bg-gray-700">Limpiar</button>
        </div>
        
        <button onclick="openGoogleMaps()" class="btn w-full bg-blue-600 hover:bg-blue-700 mb-6">
            <svg class="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zM4.06 13.94a.5.5 0 00.353.146.5.5 0 00.354-.146l2.122-2.122A5.96 5.96 0 0110 6c-3.313 0-6 2.687-6 6a5.96 5.96 0 01.06-1.06zM10 14a4 4 0 110-8 4 4 0 010 8zm0-6a2 2 0 100 4 2 2 0 000-4z"/></svg>
            Abrir Maps
        </button>

        <!-- Resultados -->
        <div id="resultsContainer" class="hidden bg-gray-700 rounded-xl p-4 mb-8">
            <h3 class="text-xl font-bold text-center text-green-400 mb-4">Resumen de Costos</h3>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <p class="text-gray-400">Total KM (Redondo)</p>
                    <input type="text" id="resultKmReal" class="bg-gray-800 text-green-300 font-bold" readonly>
                </div>
                <div>
                    <p class="text-gray-400">Costo (Tarifa 21)</p>
                    <input type="text" id="resultPrecio21" class="bg-gray-800 text-green-300 font-bold" readonly>
                </div>
            </div>
            <div class="mt-4">
                <p class="text-gray-400 text-sm">Costo (Tarifa 24)</p>
                <input type="text" id="resultPrecio24" class="bg-gray-800 text-green-300 font-bold w-full" readonly>
            </div>
            <button onclick="saveToHistoryAndClear()" class="btn w-full mt-4 bg-green-600 hover:bg-green-700">Confirmar y Guardar</button>
        </div>

        <!-- Mensajes -->
        <div id="messageBox" class="hidden p-4 mb-6 rounded-lg bg-yellow-900 text-yellow-200 text-center font-bold"></div>

        <!-- Historial y Reportes -->
        <div class="mt-8 border-t border-gray-700 pt-8">
            <h2 class="text-xl font-bold mb-4 flex justify-between items-center">
                Historial de Viajes
                <span id="historyCount" class="bg-gray-700 text-xs px-2 py-1 rounded-full text-gray-300">0</span>
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
                <button onclick="exportToExcel()" class="btn bg-green-700 hover:bg-green-800 text-sm">
                    <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    Descargar Excel
                </button>
                <button onclick="exportToPDF()" class="btn bg-red-600 hover:bg-red-700 text-sm">
                    <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                    Generar Reporte PDF
                </button>
            </div>

            <div id="tripHistoryContainer" class="space-y-3 max-h-96 overflow-y-auto">
                <!-- Items del historial se generarán aquí -->
            </div>
            
             <button onclick="clearHistory()" class="text-xs text-red-400 mt-4 underline w-full text-center">Borrar todo el historial</button>
        </div>
    </div>
</div>

<script>
    // --- DATOS Y CONFIGURACIÓN ---
    const citiesData = [
        {"CIUDAD": "TAMPICO", "KM": 0}, {"CIUDAD": "SAN FELIPE ORIZATLAN", "KM": 275},
        {"CIUDAD": "CD VALLES", "KM": 150}, {"CIUDAD": "CD VICTORIA", "KM": 238},
        {"CIUDAD": "PANUCO", "KM": 55}, {"CIUDAD": "HUEJUTLA", "KM": 169},
        {"CIUDAD": "CD. MANTE", "KM": 163}, {"CIUDAD": "NARANJOS", "KM": 125},
        {"CIUDAD": "MONTERREY", "KM": 500}, {"CIUDAD": "CD. DE MEXICO", "KM": 480},
        {"CIUDAD": "ALAMO", "KM": 130}, {"CIUDAD": "CERRO AZUL", "KM": 150},
        {"CIUDAD": "OZULUAMA", "KM": 50}, {"CIUDAD": "POTRERO DEL LLANO", "KM": 160},
        {"CIUDAD": "TAMAZUNCHALE", "KM": 220}, {"CIUDAD": "MATAMOROS", "KM": 300},
        {"CIUDAD": "TEMPOAL", "KM": 80}, {"CIUDAD": "TANTOYUCA", "KM": 110},
        {"CIUDAD": "XILITLA", "KM": 230}, {"CIUDAD": "CHICONTEPEC", "KM": 170},
        {"CIUDAD": "POZA RICA", "KM": 190}, {"CIUDAD": "TEPETZINTLA", "KM": 170}
    ];

    // Variables UI
    const el = (id) => document.getElementById(id);
    let deferredPrompt; // Para la instalación PWA

    // --- INICIALIZACIÓN ---
    document.addEventListener('DOMContentLoaded', () => {
        // Llenar selects
        const createOption = (city) => `<option value="${city.KM}">${city.CIUDAD}</option>`;
        const options = '<option value="" disabled selected>-- Seleccionar --</option>' + 
                        citiesData.map(createOption).join('');
        
        el('citySelectSalida').innerHTML = options;
        el('citySelectLlegada').innerHTML = options;

        // Establecer fecha hoy
        el('tripDate').valueAsDate = new Date();

        loadHistory();
        initPWA();
    });

    // Eventos cambio de ciudad
    el('citySelectLlegada').addEventListener('change', (e) => {
        el('customLocationInput').value = '';
        el('kmInput').value = e.target.value;
    });
    
    el('customLocationInput').addEventListener('input', () => {
        el('citySelectLlegada').value = '';
    });

    // --- LÓGICA DE NEGOCIO ---
    function calculateCost() {
        const kmIda = parseFloat(el('kmInput').value);
        if (!kmIda || kmIda <= 0) return showMsg("Ingresa un kilometraje válido");

        const kmMaps = kmIda * 2; // Ida y vuelta
        const kmReal = kmMaps * 1.142857; // Factor de ajuste
        const p21 = kmIda * 3.5;
        const p24 = kmIda * 4.0;

        el('resultKmReal').value = kmReal.toFixed(2);
        el('resultPrecio21').value = `$${p21.toFixed(2)}`;
        el('resultPrecio24').value = `$${p24.toFixed(2)}`;
        
        // Guardamos valores temporales en el botón para usarlos al guardar
        el('resultsContainer').dataset.temp = JSON.stringify({
            kmIda, kmMaps, kmReal, p21, p24
        });

        el('resultsContainer').classList.remove('hidden');
        el('messageBox').classList.add('hidden');
    }

    function saveToHistoryAndClear() {
        const temp = JSON.parse(el('resultsContainer').dataset.temp);
        const trip = {
            id: Date.now(),
            salida: el('citySelectSalida').options[el('citySelectSalida').selectedIndex]?.text || "Desconocido",
            llegada: el('customLocationInput').value || el('citySelectLlegada').options[el('citySelectLlegada').selectedIndex]?.text,
            fecha: el('tripDate').value,
            ...temp
        };

        let history = JSON.parse(localStorage.getItem('tripHistory')) || [];
        history.unshift(trip);
        localStorage.setItem('tripHistory', JSON.stringify(history));
        
        loadHistory();
        resetCalculator();
        showMsg("Viaje guardado correctamente");
    }

    function resetCalculator() {
        el('citySelectSalida').value = '';
        el('citySelectLlegada').value = '';
        el('customLocationInput').value = '';
        el('kmInput').value = '';
        el('resultsContainer').classList.add('hidden');
        el('messageBox').classList.add('hidden');
    }

    // --- REPORTES (PDF & EXCEL) ---
    
    // Generar PDF usando jsPDF y AutoTable
    function exportToPDF() {
        const history = JSON.parse(localStorage.getItem('tripHistory')) || [];
        if (history.length === 0) return showMsg("Sin datos para reporte PDF");

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Encabezado
        doc.setFillColor(45, 55, 72); // Gris oscuro
        doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(22);
        doc.text("Reporte de Kilometraje TI", 14, 25);
        doc.setFontSize(10);
        doc.text(`Generado: ${new Date().toLocaleDateString()}`, 14, 35);

        // Tabla
        const tableColumn = ["Fecha", "Ruta (Salida > Llegada)", "KM Total", "Costo ($)"];
        const tableRows = [];
        let totalCosto = 0;
        let totalKM = 0;

        history.forEach(trip => {
            const tripData = [
                trip.fecha,
                `${trip.salida} \n-> ${trip.llegada}`,
                trip.kmReal.toFixed(2),
                `$${trip.p24.toFixed(2)}` // Usando tarifa 24 como ejemplo
            ];
            tableRows.push(tripData);
            totalCosto += trip.p24;
            totalKM += trip.kmReal;
        });

        // Totales al final
        tableRows.push(["", "TOTALES ACUMULADOS", `${totalKM.toFixed(2)} KM`, `$${totalCosto.toFixed(2)}`]);

        doc.autoTable({
            head: [tableColumn],
            body: tableRows,
            startY: 45,
            theme: 'grid',
            headStyles: { fillColor: [66, 153, 225] }, // Azul Tailwind
            styles: { fontSize: 8, cellPadding: 3 },
            columnStyles: { 
                1: { cellWidth: 80 }, // Columna Ruta más ancha
                3: { fontStyle: 'bold', halign: 'right' }
            }
        });

        // Pie de página
        const finalY = doc.lastAutoTable.finalY + 10;
        doc.setTextColor(100);
        doc.text("Firma de Conformidad:", 14, finalY);
        doc.line(14, finalY + 15, 80, finalY + 15); // Línea de firma

        doc.save(`Reporte_Gastos_${new Date().toISOString().slice(0,10)}.pdf`);
        showMsg("PDF descargado correctamente");
    }

    function exportToExcel() {
        const history = JSON.parse(localStorage.getItem('tripHistory')) || [];
        if (history.length === 0) return showMsg("Sin datos para Excel");

        const wsData = [["Fecha", "Salida", "Llegada", "KM Maps", "KM Real", "Costo 21", "Costo 24"]];
        history.forEach(t => {
            wsData.push([t.fecha, t.salida, t.llegada, t.kmMaps, t.kmReal, t.p21, t.p24]);
        });

        const ws = XLSX.utils.aoa_to_sheet(wsData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Gastos");
        XLSX.writeFile(wb, "Reporte_Kilometraje.xlsx");
    }

    // --- UTILIDADES ---
    function loadHistory() {
        const history = JSON.parse(localStorage.getItem('tripHistory')) || [];
        const container = el('tripHistoryContainer');
        el('historyCount').innerText = history.length;
        
        if (history.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500 italic">No hay registros recientes.</p>`;
            return;
        }

        container.innerHTML = history.map((t, idx) => `
            <div class="bg-gray-700 p-4 rounded-lg border-l-4 border-indigo-500 shadow-md">
                <div class="flex justify-between items-start mb-3 border-b border-gray-600 pb-2">
                    <div class="overflow-hidden mr-2">
                        <h4 class="font-bold text-indigo-300 text-lg truncate">${t.llegada}</h4>
                        <p class="text-xs text-gray-400 font-medium">${t.fecha} <span class="mx-1 text-gray-600">|</span> Desde: ${t.salida}</p>
                    </div>
                    <button onclick="deleteTrip(${idx})" class="text-xs text-red-400 hover:text-red-200 bg-red-900/20 px-2 py-1 rounded border border-red-900/50 transition-colors">
                        Eliminar
                    </button>
                </div>
                
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div class="bg-gray-800/50 p-2 rounded">
                        <span class="block text-[10px] uppercase tracking-wider text-gray-500 mb-1">Distancia Maps</span>
                        <span class="font-mono text-gray-300">${t.kmMaps.toFixed(2)} km</span>
                    </div>
                    <div class="bg-gray-800/50 p-2 rounded">
                        <span class="block text-[10px] uppercase tracking-wider text-gray-500 mb-1">Distancia Real</span>
                        <span class="font-mono text-gray-300">${t.kmReal.toFixed(2)} km</span>
                    </div>
                    <div class="bg-gray-800/50 p-2 rounded border border-green-900/30">
                        <span class="block text-[10px] uppercase tracking-wider text-gray-500 mb-1">Costo (21)</span>
                        <span class="font-bold text-green-400">$${t.p21.toFixed(2)}</span>
                    </div>
                    <div class="bg-gray-800/50 p-2 rounded border border-green-900/30">
                        <span class="block text-[10px] uppercase tracking-wider text-gray-500 mb-1">Costo (24)</span>
                        <span class="font-bold text-green-300 text-base">$${t.p24.toFixed(2)}</span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function deleteTrip(index) {
        let history = JSON.parse(localStorage.getItem('tripHistory'));
        history.splice(index, 1);
        localStorage.setItem('tripHistory', JSON.stringify(history));
        loadHistory();
    }
    
    function clearHistory() {
        if(confirm("¿Borrar todo el historial?")) {
            localStorage.removeItem('tripHistory');
            loadHistory();
        }
    }

    function showMsg(txt) {
        const box = el('messageBox');
        box.innerText = txt;
        box.classList.remove('hidden');
        setTimeout(() => box.classList.add('hidden'), 3000);
    }
    
    function openGoogleMaps() {
        const salida = el('citySelectSalida').options[el('citySelectSalida').selectedIndex]?.text || "Ubicación Actual";
        const llegada = el('customLocationInput').value || el('citySelectLlegada').options[el('citySelectLlegada').selectedIndex]?.text;
        if(!llegada) return showMsg("Define un destino");
        window.open(`https://www.google.com/maps/dir/${encodeURIComponent(salida)}/${encodeURIComponent(llegada)}`, '_blank');
    }

    // --- PWA LOGIC ---
    function initPWA() {
        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('SW registrado', reg))
                .catch(err => console.log('SW error', err));
        }

        // Manejar instalación
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            el('installContainer').classList.remove('hidden');
        });

        el('btnInstall').addEventListener('click', async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                el('installContainer').classList.add('hidden');
            }
            deferredPrompt = null;
        });
    }
</script>
</body>
</html>